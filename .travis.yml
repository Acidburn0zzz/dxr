sudo: required

# Keep the sliding forward of the ci branch from triggering another build:
branches:
  except:
    - ci

# We don't use these facilities, but they're lightweight:
language: C

services:
  - docker

before_install:
  # Normalize ownership UIDs between host and container so container can write:
  - sudo chown -R 1000 .
  - make docker_es

script:
  - docker-compose -f tooling/docker/docker-compose.yml run -e DXR_PROD=1 dev make test

notifications:
  email: false
  irc:
    channels:
      - "irc.mozilla.org#static"
    template:
      - "[%{repository_name} %{branch}] \"%{commit_subject}\" by %{author}: %{result}"
      - "Changes: %{compare_url}"
      - "Build details: %{build_url}"

deploy:
  provider: script
  script: git push -q "https://${GH_TOKEN}@${GH_REF}" master:ci > /dev/null 2>&1
  on:
    branch: master
  skip_cleanup: true

env:
  global:
    - GH_REF: github.com/mozilla/dxr.git
    - secure: "ZaFYROXPqDRTb9iPK196ar5rOHDIcOw7xD7kV0bbXMAaJZv7T7TmQQ9gRso/qwwAeOKO4IRi9iGRDQU5yqZ4hy6FbVXUV6AXI3QXbm0X+qd38kboXzwfbpwfRpZRj5CmzZ32wo3w4jtB7OSzX6OvP+7J5YHRoRwTj30JLhLrXfk="